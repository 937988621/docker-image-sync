name: Sync Docker Images

on:
  push:
    paths:
      - 'images.yaml'
    branches:
      - main
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Install yq
        run: sudo snap install yq

      - name: Pull and tag images
        run: |
          echo "=== Pulling and tagging images ==="
          yq eval -o=j '.images[]' images.yaml | while read -r image; do
            name=$(echo "$image" | yq '.name')
            tag=$(echo "$image" | yq '.tag')
            aliyun=$(echo "$image" | yq '.aliyun // ""')
            tencent=$(echo "$image" | yq '.tencent // ""')

            echo "→ Processing $name:$tag"
            docker pull "$name:$tag"

            if [ -n "$aliyun" ] && [ "$aliyun" != "null" ]; then
              echo "  ↳ Tagging for Aliyun: registry.aliyuncs.com/$aliyun"
              docker tag "$name:$tag" "registry.aliyuncs.com/$aliyun"
            fi

            if [ -n "$tencent" ] && [ "$tencent" != "null" ]; then
              echo "  ↳ Tagging for Tencent: ccr.ccs.tencentyun.com/$tencent"
              docker tag "$name:$tag" "ccr.ccs.tencentyun.com/$tencent"
            fi
          done

      - name: Log in to Aliyun Docker Registry
        if: ${{ secrets.ALIYUN_USERNAME != '' && secrets.ALIYUN_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          registry: registry.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Log in to Tencent Docker Registry
        if: ${{ secrets.TENCENT_USERNAME != '' && secrets.TENCENT_PASSWORD != '' }}
        uses: docker/login-action@v3
        with:
          registry: ccr.ccs.tencentyun.com
          username: ${{ secrets.TENCENT_USERNAME }}
          password: ${{ secrets.TENCENT_PASSWORD }}

      - name: Push images
        run: |
          echo "=== Pushing tagged images ==="
          yq eval -o=j '.images[]' images.yaml | while read -r image; do
            name=$(echo "$image" | yq '.name')
            tag=$(echo "$image" | yq '.tag')
            aliyun=$(echo "$image" | yq '.aliyun // ""')
            tencent=$(echo "$image" | yq '.tencent // ""')

            if [ -n "$aliyun" ] && [ "$aliyun" != "null" ] && [ -n "${{ secrets.ALIYUN_USERNAME }}" ]; then
              echo "→ Pushing to Aliyun: registry.aliyuncs.com/$aliyun"
              docker push "registry.aliyuncs.com/$aliyun"
            else
              echo "→ Skipping Aliyun push for $name:$tag"
            fi

            if [ -n "$tencent" ] && [ "$tencent" != "null" ] && [ -n "${{ secrets.TENCENT_USERNAME }}" ]; then
              echo "→ Pushing to Tencent: ccr.ccs.tencentyun.com/$tencent"
              docker push "ccr.ccs.tencentyun.com/$tencent"
            else
              echo "→ Skipping Tencent push for $name:$tag"
            fi
          done
